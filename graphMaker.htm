<html>
<script type="text/javascript" src="onload.js"></script>
<script type="text/javascript" src="objects.js"></script>
<script>
var ctx,
	pointCounter,
	HEIGHT = 400,
	WIDTH  = 500,
	ACTIVE_POINT,
	ACTIVE_ARROW = [],
	onMove = false,
	timer,
	points = new Set(),
	arrows = new Set(),
	delay = false,
	activeKey,
	mousePosX,
	mousePosY,
	k = 1;

window.onkeydown = () => {
	activeKey = event.keyCode;
}
window.onkeyup = () => {
	activeKey = 0;
	ACTIVE_ARROW.length = 0;
}

function update() {
	ctx.clearRect(0,0,WIDTH,HEIGHT);
	for (let a of arrows) {
		a.draw();
	}

	for (let p of points) {
		if (p.get("x")-p.get("r") <= 0) p.set("x", p.get("r"));
		if (p.get("x")+p.get("r") >= WIDTH) p.set("x", WIDTH-p.get("r"));
		if (p.get("y")-p.get("r") <= 0) p.set("y", p.get("r"));
		if (p.get("y")+p.get("r") >= HEIGHT) p.set("y", HEIGHT-p.get("r"));
		p.set("bg", "default");
		if (p == ACTIVE_POINT) {
			p.set("bg", "red");
		} 

		reNum();
		p.draw();
	}

	pointCounter.innerText = "Point count: " + points.size;
}

function addPoint() {
	var newPoint = new point();

	if (event.target.tagName == "CANVAS") {
		newPoint.set("x", mousePosX);
		newPoint.set("y", mousePosY);
	}

	ACTIVE_POINT = newPoint;
	points.add(newPoint)
	newPoint.set("text", points.size);

	update();
}

function getPoint() {
	var elem = event.target.getBoundingClientRect(),
		clickX = event.clientX - elem.left,
		clickY = event.clientY - elem.top,
		onMouse1 = event.button == 0 ? true : false;

	for (let p of points) {
		var X = p.get("x"),
			Y = p.get("y"),
			R = p.get("r"),
			area = Math.pow(clickX-X, 2) + Math.pow(clickY-Y, 2);
		if (area < R*R) {
			ACTIVE_POINT = p;
			if (onMouse1) {
				if (activeKey == 17) {
					ACTIVE_ARROW.push(ACTIVE_POINT);

					if ((ACTIVE_ARROW.length >= 2) && (ACTIVE_ARROW[0] != ACTIVE_ARROW[1])) {
						var newArrow = new arrow(ACTIVE_ARROW[0], ACTIVE_ARROW[1]);

						for (let a of arrows) {
							if (a.get("start") == ACTIVE_ARROW[0] || a.get("start") == ACTIVE_ARROW[1]) 
								if (a.get("end") == ACTIVE_ARROW[0] || a.get("end") == ACTIVE_ARROW[1])
									return false;
						}
						
						arrows.add(newArrow);

						ACTIVE_ARROW.length = 0;
						
					} else if (ACTIVE_ARROW.length >= 2) {
						ACTIVE_ARROW.length = 0;
					}
					update();
					return false;
				} 

				timer = setTimeout(function(){
					onMove = true;
					clearTimeout(timer);
					}, 10)
				break;
			} else if (!delay) {
				delay = true;
				for (let a of arrows) {
					if ((a.get("start") == ACTIVE_POINT) || (a.get("end") == ACTIVE_POINT))
						arrows.delete(a);
				}
				points.delete(ACTIVE_POINT);
				update();

				timer = setTimeout(function(){
					delay = false;
					clearTimeout(timer);
					}, 300)
				break;
			}
		}
	}	

	return false;
}
function dragPoint() {
	var elem = event.target.getBoundingClientRect();
	mousePosX = event.clientX - elem.left;
	mousePosY = event.clientY - elem.top;

	if (!onMove) return false;

	ACTIVE_POINT.set("x", mousePosX);
	ACTIVE_POINT.set("y", mousePosY);

	update();
}
function dragReset() {
	onMove = false;
}
function reNum() {
	var k = 1;
	for (let p of points) {
		p.set("text", k);
		k++;
	}
}
</script>
<style>
* {
	margin: 0;
	padding: 0;
	font: 15px Arial;
	color: #5a5a5a;
	user-select: none;
}
#main_container {
	width: 600px;
	height: 300px;
	position: absolute;
	margin: auto;
	display: inline-block;
	left: 0;
	right: 0;
	top: 0;
	bottom: 0;
}
#point_counter {
	width: calc(600px - 15px);
	height: 20px;
	padding-left: 15px;
	line-height: 20px;
	position: absolute;
	top: -21px;
	background: linear-gradient(to bottom, #eee, #fff);
}
nav, canvas {
	float: left;
}
canvas {
	border: solid 1px grey;
	margin: -1px;
}
nav {
	width: 200px;
	height: 300px;
}
.butt {
	border: solid 2px #bbb;
	border-radius: 5px;
	margin: 5px;
	padding: 10px 5px;
	text-align: center;
	user-select: none;
	cursor: pointer;
	background: linear-gradient(to bottom, #eee, #fff);
}
	.butt:hover {
		border-color: #5a5a5a;
	}
	.butt:active {
		background: linear-gradient(to top, #eee, #fff)
	}
</style>
	<div id="main_container">
		<div id="point_counter">Point count: 0</div>
		<nav>
			<div onclick="addPoint()" class="butt">Add</div>
		</nav>
		<canvas id="cnv">
		</canvas>
	</div>
</html>